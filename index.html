<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Minecraft Phase 7: Guaranteed Load</title>
<style>
  body { margin: 0; overflow: hidden; background: #87ceeb; font-family: monospace; user-select: none; }
  
  /* UI LAYERS */
  #game-ui { visibility: hidden; } /* Hidden until loaded */
  
  #crosshair {
    position: fixed; top: 50%; left: 50%;
    width: 10px; height: 10px;
    margin-left: -5px; margin-top: -5px;
    border: 2px solid white; box-sizing: border-box;
    pointer-events: none; z-index: 10;
  }

  #ui-container {
    position: fixed; bottom: 10px; left: 50%;
    transform: translateX(-50%);
    text-align: center; pointer-events: none;
  }

  /* LOADING SCREEN */
  #loading-screen {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #222; z-index: 100;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
  }
  
  #loading-text {
    color: white; font-size: 20px; margin-bottom: 20px; font-weight: bold;
  }
  
  #progress-bar-box {
    width: 300px; height: 30px; border: 3px solid white; padding: 2px;
  }
  
  #progress-bar {
    width: 0%; height: 100%; background: #4caf50; transition: width 0.1s;
  }

  #hotbar {
    display: flex; gap: 4px; justify-content: center; margin-top: 6px;
    background: rgba(0,0,0,0.2); padding: 5px; border-radius: 5px;
  }
  
  .slot {
    width: 44px; height: 44px; background: #8b8b8b; 
    border: 3px solid #373737;
    border-top: 3px solid #FFF; border-left: 3px solid #FFF;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    position: relative;
  }
  .slot.selected { background: #bbb; border-color: white; }
  .slot-icon { width: 32px; height: 32px; image-rendering: pixelated; }
  .count { position: absolute; bottom: 2px; right: 2px; font-size: 14px; color: white; text-shadow: 2px 2px 0 #000; }
  .key-bind { position: absolute; top: 2px; left: 2px; font-size: 10px; color: #444; font-weight: bold; }
</style>
</head>
<body>

<div id="loading-screen">
  <div id="loading-text">GENERATING WORLD... 0%</div>
  <div id="progress-bar-box"><div id="progress-bar"></div></div>
</div>

<div id="game-ui">
  <div id="crosshair"></div>
  <div id="ui-container">
    <div id="hotbar"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>

<script>
// --- CONFIGURATION ---
const RENDER_DISTANCE = 8; 
const WORLD_BORDER = 1000;
const SPEED_WALK = 0.14;   
const SPEED_SPRINT = 0.24; 
const SPEED_FLY = 0.40;    
const JUMP_FORCE = 0.27;   
const GRAVITY = 0.022;     

// --- SCENE SETUP ---
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);
scene.fog = new THREE.Fog(0x87ceeb, 8, 24);

// LIGHTING
const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
scene.add(ambientLight);
const dirLight = new THREE.DirectionalLight(0xffffff, 0.7);
dirLight.position.set(20, 50, 20);
scene.add(dirLight);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
camera.rotation.order = "YXZ";

const renderer = new THREE.WebGLRenderer({ antialias: false });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(1);
document.body.appendChild(renderer.domElement);

// --- TEXTURE SYSTEM ---
const textureCanvas = document.createElement("canvas");
textureCanvas.width = 16; textureCanvas.height = 16;
const ctx = textureCanvas.getContext("2d");

function createTexture(drawFn) {
  ctx.clearRect(0,0,16,16);
  drawFn(ctx);
  const tex = new THREE.CanvasTexture(textureCanvas);
  tex.magFilter = THREE.NearestFilter;
  tex.minFilter = THREE.NearestFilter;
  tex.colorSpace = THREE.SRGBColorSpace;
  const dataUrl = textureCanvas.toDataURL();
  const copy = document.createElement("canvas");
  copy.width=16; copy.height=16;
  copy.getContext("2d").drawImage(textureCanvas,0,0);
  const distinctTex = new THREE.CanvasTexture(copy);
  distinctTex.magFilter = THREE.NearestFilter;
  distinctTex.colorSpace = THREE.SRGBColorSpace;
  return { tex: distinctTex, icon: dataUrl };
}

function fillNoise(ctx, colors) {
  for(let y=0; y<16; y++) {
    for(let x=0; x<16; x++) {
      ctx.fillStyle = colors[Math.floor(Math.random()*colors.length)];
      ctx.fillRect(x,y,1,1);
    }
  }
}

function drawPixels(ctx, map, palette) {
  for(let y=0; y<16; y++) {
    for(let x=0; x<16; x++) {
      const char = map[y][x];
      if (char !== " ") {
        ctx.fillStyle = palette[char];
        ctx.fillRect(x,y,1,1);
      }
    }
  }
}

// TEXTURES
const tGrassTop = createTexture(c => fillNoise(c, ["#4caf50", "#388e3c"]));
const tGrassSide = createTexture(c => { fillNoise(c, ["#795548", "#5d4037"]); c.fillStyle = "#4caf50"; c.fillRect(0,0,16,4); });
const tDirt = createTexture(c => fillNoise(c, ["#795548", "#5d4037"]));
const tStone = createTexture(c => fillNoise(c, ["#9e9e9e", "#757575", "#616161"]));
const tWood = createTexture(c => { fillNoise(c, ["#5d4037", "#4e342e"]); c.fillStyle = "#3e2723"; c.fillRect(4,0,2,16);

const pickMap = ["   BBBB         ", "   B  B         ", "   B  B         ", "    SS          ", "    SS          ", "    SS          ",
